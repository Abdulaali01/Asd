<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ğŸ“‹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª â€” Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© v21</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{font-family:Tahoma,Arial,sans-serif;background:#fafafa;margin:0;padding:18px}
h2{margin:0 0 12px}
.toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
button{padding:6px 10px;border:none;border-radius:8px;cursor:pointer}
.btn{background:#eee}
.btn-view{background:#0b74da;color:#fff}
.btn-wa{background:#25D366;color:#fff}
.btn-done{background:#f44336;color:#fff}
.copy-btn{background:#555;color:#fff;border-radius:4px;padding:2px 6px;font-size:11px}
table{width:100%;min-width:900px;border-collapse:collapse;background:#fff}
th,td{border:1px solid #ddd;padding:6px;text-align:center;vertical-align:middle}
th{background:#f0f0f0}
tr.done-row{background:#ffdddd}

.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);justify-content:center;align-items:center;z-index:9999;padding:14px}
.modal-content{background:#fff;border-radius:10px;padding:14px;max-height:95vh;overflow:auto;width:95vw;max-width:1100px}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.close{cursor:pointer;color:#d00;font-weight:bold;font-size:18px}

.calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:2px}
.calendar .header{background:#eee;font-weight:bold}
.calendar div{border:1px solid #ccc;border-radius:4px;padding:4px;min-height:85px;font-size:12px;background:#fff}
.calendar .day{position:relative;cursor:pointer}
.calendar .day span{display:block;font-size:10px;margin-top:2px;line-height:11px}

.blink{animation:blinkAnim 1s infinite;}
@keyframes blinkAnim{
0%{opacity:1}
50%{opacity:0.3}
100%{opacity:1}
}
</style>
</head>

<body>

<h2>ğŸ“‹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h2>

<div class="toolbar">
<input type="file" id="file" accept=".xlsx,.xls">
<button class="btn" id="btnCalendar">ğŸ“… Ø§Ù„ÙƒÙ„ÙŠÙ†Ø¯Ø± Ø§Ù„Ø´Ù‡Ø±ÙŠ</button>
</div>

<div id="countRow" style="margin:6px 0; display:none">Ø¹Ø¯Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬: <b id="count">0</b></div>
<table id="tbl" style="display:none"></table>

<div id="calendarModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h3>ğŸ“… Ø§Ù„ÙƒÙ„ÙŠÙ†Ø¯Ø± Ø§Ù„Ø´Ù‡Ø±ÙŠ</h3>
<span class="close" onclick="toggleModal('calendarModal',false)">âœ–</span>
</div>
<input type="month" id="monthPicker">
<div id="calendarGrid" class="calendar"></div>
</div>
</div>

<div id="viewModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h3>ğŸ“‹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©</h3>
<span class="close" onclick="toggleModal('viewModal',false)">âœ–</span>
</div>
<table id="modalTbl"></table>
<div style="margin-top:8px">
<button class="btn-done" onclick="markAllDuplicatesDone()">âœ”ï¸ ØªÙ… Ù„Ù„Ø¬Ù…ÙŠØ¹</button>
</div>
</div>
</div>

<script>

const STORAGE_KEY = location.hostname + "_doneOrders";
let doneStore = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");

const state={rows:[],dateCol:"ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡",mobileCol:"Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…Ø³ØªÙÙŠØ¯"};
const $=id=>document.getElementById(id);
let currentMobile=null;

const TARGET_STATUSES=[
"Ù…Ø¹Ù„Ù‚ - Ù‚Ø±Ø§Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©",
"Ù…Ø¹Ù„Ù‚ - Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ø´Ø±Ù"
];

$("file").addEventListener("change",async e=>{
const buf=await e.target.files[0].arrayBuffer();
const wb=XLSX.read(buf,{type:"array"});
const ws=wb.Sheets[wb.SheetNames[0]];

state.rows=XLSX.utils.sheet_to_json(ws,{defval:""}).map(r=>{
let p=String(r[state.mobileCol]||"").replace(/\D/g,"");
if(p.startsWith("0"))p="966"+p.slice(1);
else if(!p.startsWith("966"))p="966"+p;
r[state.mobileCol]=p;
if(doneStore.includes(String(r["Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨"]))) r["Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨"]="ØªÙ… Ø¥Ù†Ø¬Ø§Ø²Ù‡";
return r;
});
});

$("btnCalendar").onclick=()=>{
toggleModal("calendarModal",true);
$("monthPicker").value=new Date().toISOString().slice(0,7);
renderCalendar();
};

$("monthPicker").onchange=renderCalendar;

function renderCalendar(){
const m=$("monthPicker").value;
if(!m)return;
const[y,mm]=m.split("-");
const year=parseInt(y),month=+mm-1;
const first=new Date(year,month,1);
const last=new Date(year,month+1,0);
const grid=$("calendarGrid");
grid.innerHTML="";
["Ø£Ø­Ø¯","Ø¥Ø«Ù†ÙŠÙ†","Ø«Ù„Ø§Ø«Ø§Ø¡","Ø£Ø±Ø¨Ø¹Ø§Ø¡","Ø®Ù…ÙŠØ³","Ø¬Ù…Ø¹Ø©","Ø³Ø¨Øª"].forEach(d=>{
const h=document.createElement("div");
h.textContent=d;h.className="header";grid.appendChild(h);
});
for(let i=0;i<first.getDay();i++)grid.appendChild(document.createElement("div"));
for(let d=1;d<=last.getDate();d++){
const cell=document.createElement("div");cell.className="day";cell.innerHTML=d;
const ds=`${year}-${pad(month+1)}-${pad(d)}`;
const rows=state.rows.filter(r=>normalizeDate(r[state.dateCol])===ds);
const pending=rows.filter(r=>TARGET_STATUSES.includes(r["Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨"]||""));
const total=pending.length;
if(rows.length>0)cell.innerHTML+=`<span>Ù…Ø¹Ù„Ù‚:${total}</span>`;
if(rows.length>0&&total===0)cell.style.background="#c8e6c9";
if(rows.length>0&&total>0)cell.style.background="#ffe0b2";
grid.appendChild(cell);
}
}

function markDone(btn,order,dateStr){
const tr=btn.closest("tr");
tr.classList.add("done-row");
tr.querySelector(".status-cell").textContent="ØªÙ… Ø¥Ù†Ø¬Ø§Ø²Ù‡";
if(!doneStore.includes(order)){
doneStore.push(order);
localStorage.setItem(STORAGE_KEY,JSON.stringify(doneStore));
}
renderCalendar();
}

function markAllDuplicatesDone(){
state.rows.filter(r=>String(r[state.mobileCol])===String(currentMobile)).forEach(r=>{
const id=String(r["Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨"]);
if(!doneStore.includes(id))doneStore.push(id);
});
localStorage.setItem(STORAGE_KEY,JSON.stringify(doneStore));
renderCalendar();
toggleModal("viewModal",false);
}

function toggleModal(id,s){$(id).style.display=s?"flex":"none";}
function pad(n){return String(n).padStart(2,"0")}
function normalizeDate(r){const d=new Date(r);return`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`}

</script>
</body>
</html>
