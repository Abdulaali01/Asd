<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ğŸ“‹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª â€” Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© v21</title>

<!-- Ù…ÙƒØªØ¨Ø§Øª -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  body{font-family:Tahoma,Arial,sans-serif;background:#fafafa;margin:0;padding:18px}
  h2{margin:0 0 12px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
  button{padding:6px 10px;border:none;border-radius:8px;cursor:pointer}
  .btn{background:#eee}
  .btn-view{background:#0b74da;color:#fff}
  .btn-wa{background:#25D366;color:#fff}
  .btn-done{background:#f44336;color:#fff}
  .copy-btn{background:#555;color:#fff;border-radius:4px;padding:2px 6px;font-size:11px}
  table{width:100%;min-width:900px;border-collapse:collapse;background:#fff}
  th,td{border:1px solid #ddd;padding:6px;text-align:center;vertical-align:middle}
  th{background:#f0f0f0}
  tr.done-row{background:#ffdddd}

  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);justify-content:center;align-items:center;z-index:9999;padding:14px}
  .modal-content{background:#fff;border-radius:10px;padding:14px;max-height:95vh;overflow:auto;width:95vw;max-width:1100px}
  .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .close{cursor:pointer;color:#d00;font-weight:bold;font-size:18px}

  .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:2px}
  .calendar .header{background:#eee;font-weight:bold}
  .calendar div{border:1px solid #ccc;border-radius:4px;padding:4px;min-height:85px;font-size:12px;background:#fff}
  .calendar .day{position:relative;cursor:pointer}
  .calendar .day span{display:block;font-size:10px;margin-top:2px;line-height:11px}

  .blink{animation:blinkAnim 1s infinite;}
  @keyframes blinkAnim{
    0%{opacity:1}
    50%{opacity:0.3}
    100%{opacity:1}
  }
</style>
</head>

<body>

<h2>ğŸ“‹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h2>

<div class="toolbar">
  <input type="file" id="file" accept=".xlsx,.xls">
  <button class="btn" id="btnCalendar">ğŸ“… Ø§Ù„ÙƒÙ„ÙŠÙ†Ø¯Ø± Ø§Ù„Ø´Ù‡Ø±ÙŠ</button>
</div>

<div id="countRow" style="margin:6px 0; display:none">Ø¹Ø¯Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬: <b id="count">0</b></div>
<table id="tbl" style="display:none"></table>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ÙƒÙ„ÙŠÙ†Ø¯Ø± -->
<div id="calendarModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ğŸ“… Ø§Ù„ÙƒÙ„ÙŠÙ†Ø¯Ø± Ø§Ù„Ø´Ù‡Ø±ÙŠ</h3>
      <span class="close" onclick="toggleModal('calendarModal',false)">âœ–</span>
    </div>
    <input type="month" id="monthPicker">
    <div id="calendarGrid" class="calendar" style="margin-top:6px"></div>
  </div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ù…ØªÙƒØ±Ø±Ø© -->
<div id="viewModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ğŸ“‹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©</h3>
      <span class="close" onclick="toggleModal('viewModal',false)">âœ–</span>
    </div>
    <table id="modalTbl"></table>
    <div style="margin-top:8px">
      <button class="btn-done" onclick="markAllDuplicatesDone()">âœ”ï¸ ØªÙ… Ù„Ù„Ø¬Ù…ÙŠØ¹</button>
    </div>
  </div>
</div>

<script>
// -------------------------
// â¬…ï¸ ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ù…Ù†Ø¬Ø²Ø©
// ------------------------
const STORAGE_KEY = location.hostname + "_doneOrders";
let doneStore = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");

const state={rows:[],dateCol:"ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡",mobileCol:"Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…Ø³ØªÙÙŠØ¯"};
const $=id=>document.getElementById(id);
let currentMobile=null;

const TARGET_STATUSES=[
  "Ù…Ø¹Ù„Ù‚ - Ù‚Ø±Ø§Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©",
  "Ù…Ø¹Ù„Ù‚ - Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ø´Ø±Ù"
];

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù
$("file").addEventListener("change",async e=>{
  const f=e.target.files[0];
  if(!f) return;

  const buf=await f.arrayBuffer();
  const wb=XLSX.read(buf,{type:"array"});
  const ws=wb.Sheets[wb.SheetNames[0]];

  // ØªÙˆØ­ÙŠØ¯ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„
  state.rows = XLSX.utils.sheet_to_json(ws,{defval:""}).map(r=>{
      let p = String(r[state.mobileCol] || "").replace(/\D/g,"");
      if(p.startsWith("0")) p = "966" + p.slice(1);
      else if(!p.startsWith("966")) p = "966" + p;
      r[state.mobileCol] = p;

      // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø·Ù„Ø¨ Ù…Ø­ÙÙˆØ¸ Ù…Ø³Ø¨Ù‚Ù‹Ø§ ÙƒÙ…Ù†Ø¬Ø²
      if (doneStore.includes(String(r["Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨"]))) {
          r["Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨"] = "ØªÙ… Ø¥Ù†Ø¬Ø§Ø²Ù‡";
      }

      return r;
  });

});

// ÙØªØ­ Ø§Ù„ÙƒÙ„ÙŠÙ†Ø¯Ø±
$("btnCalendar").addEventListener("click",()=>{
  if(!state.rows.length) return;
  toggleModal("calendarModal",true);
  $("monthPicker").value=new Date().toISOString().slice(0,7);
  renderCalendar();
});
$("monthPicker").addEventListener("change",renderCalendar);

// Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„
function renderMainTable(rows){
  const table=$("tbl");
  table.innerHTML="";
  $("count").textContent=rows.length;
  $("tbl").style.display="table";
  $("countRow").style.display="block";

  if(!rows.length){
    table.innerHTML="<tr><td>Ù„Ø§ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>";
    return;
  }

  const head=document.createElement("tr");
  ["Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨","Ø§Ù„ÙˆØµÙ","Ø§Ù„ØªØ§Ø±ÙŠØ®","Ø§Ù„Ø­Ø§Ù„Ø©","Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"].forEach(t=>{
    const th=document.createElement("th");
    th.textContent=t;
    head.appendChild(th);
  });
  table.appendChild(head);

  rows.forEach(r=>{
    const tr=document.createElement("tr");

    const order=(r["Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨"]||"").toString();
    const desc=(r["ÙˆØµÙ Ø§Ù„Ø·Ù„Ø¨"]||"").toString();
    const dt=normalizeDateTime(r[state.dateCol]);
    const phone=(r[state.mobileCol]||"").toString();

    tr.innerHTML = `
      <td>${order} <button class="copy-btn" data-text="${order}">ğŸ“‹</button></td>
      <td>${desc} <button class="copy-btn" data-text="${desc}">ğŸ“‹</button></td>
      <td>${dt}</td>
      <td class="status-cell">${r["Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨"]||""}</td>
      <td>
        <button class="btn-view" onclick="openViewModal('${phone}')">Ø¹Ø±Ø¶</button>
        <button class="btn-wa" onclick="sendWA('${phone}','${order}','${desc}')">ÙˆØ§ØªØ³Ø§Ø¨</button>
        <button class="btn-done" onclick="markDone(this,'${order}','${normalizeDate(r[state.dateCol])}')">ØªÙ…</button>
      </td>
    `;

    // Ù„Ùˆ Ù…Ø­ÙÙˆØ¸ Ù…Ù† Ù‚Ø¨Ù„
    if (doneStore.includes(order)) {
        tr.classList.add("done-row");
        r["Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨"] = "ØªÙ… Ø¥Ù†Ø¬Ø§Ø²Ù‡";
    }

    table.appendChild(tr);
  });
}

// ØªÙ‚ÙˆÙŠÙ…
function renderCalendar(){
  const m=$("monthPicker").value;
  if(!m) return;

  const [yy,mm]=m.split("-");
  const year=parseInt(yy), month=+mm-1;

  const first=new Date(year,month,1);
  const last=new Date(year,month+1,0);

  const grid=$("calendarGrid");
  grid.innerHTML="";

  ["Ø£Ø­Ø¯","Ø¥Ø«Ù†ÙŠÙ†","Ø«Ù„Ø§Ø«Ø§Ø¡","Ø£Ø±Ø¨Ø¹Ø§Ø¡","Ø®Ù…ÙŠØ³","Ø¬Ù…Ø¹Ø©","Ø³Ø¨Øª"].forEach(d=>{
    const h=document.createElement("div");
    h.textContent=d;
    h.className="header";
    grid.appendChild(h);
  });

  for(let i=0;i<first.getDay();i++) grid.appendChild(document.createElement("div"));

  for(let d=1; d<=last.getDate(); d++){
    const cell=document.createElement("div");
    cell.className="day";
    cell.innerHTML=d;

    const dateStr=`${year}-${pad(month+1)}-${pad(d)}`;

    // âœ… ØªØ¹Ø¯ÙŠÙ„: ÙÙ„ØªØ±Ø© Ø§Ù„ÙŠÙˆÙ… ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ normalizeDate Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø¨Ø¯Ù„ new Date Ø§Ù„Ù„ÙŠ ÙŠÙ„Ø®Ø¨Ø· Ù…Ø¹ MM/DD/YY)
    const rows = state.rows.filter(r => normalizeDate(r[state.dateCol]) === dateStr);

    const pending = rows.filter(r =>
      TARGET_STATUSES.includes(String(r["Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨"]||"").trim())
    );
    const total=pending.length;

    if(rows.length>0){
      cell.innerHTML += `<span>Ù…Ø¹Ù„Ù‚: ${total}</span>`;
    } else {
      cell.style.background="#f0f0f0";
    }

    if(rows.length>0 && total === 0){
      cell.style.background="#c8e6c9";
    }

    if(rows.length>0 && total > 0){
      // âœ… ØªØ¹Ø¯ÙŠÙ„: Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø£Ù‚Ø¯Ù… ØªØ§Ø±ÙŠØ® ØµØ­ÙŠØ­ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… parseDateTimeSafe
      const times = rows
        .map(r => parseDateTimeSafe(r[state.dateCol]))
        .filter(dt => dt && !isNaN(dt.getTime()))
        .map(dt => dt.getTime());

      const firstDate = new Date(Math.min(...times));

      const diffDays = Math.floor((new Date() - firstDate) / (1000 * 60 * 60 * 24));
      const daysLeft = 42 - diffDays;

      cell.innerHTML += `
        <span>Ù…Ø¶Ù‰: ${diffDays} ÙŠÙˆÙ…</span>
        <span>${daysLeft > 0 ? `Ø¨Ø§Ù‚ÙŠ: ${daysLeft} ÙŠÙˆÙ…` : "Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø¯Ø©"}</span>
      `;

      if(diffDays > 42){
        cell.style.background="#ff9999";
      }
      else if(diffDays === 41){
        cell.style.background="#ffcc80";
        cell.classList.add("blink");
      }
      else if(diffDays >= 35){
        cell.style.background="#fff7a3";
      }
      else{
        cell.style.background="#ffe0b2";
      }
    }

    cell.addEventListener("click",()=>{
      // âœ… ØªØ¹Ø¯ÙŠÙ„: Ù†ÙØ³ Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© (normalizeDate) + trim Ù„Ù„Ø­Ø§Ù„Ø©
      const filtered=state.rows.filter(r =>
        normalizeDate(r[state.dateCol])===dateStr &&
        TARGET_STATUSES.includes(String(r["Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨"]||"").trim())
      );
      renderMainTable(filtered);
    });

    grid.appendChild(cell);
  }
}

// Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø¬ÙˆØ§Ù„
function openViewModal(mobile){
  currentMobile=mobile;
  const rows=state.rows.filter(r=>String(r[state.mobileCol])===String(mobile));

  const table=$("modalTbl");
  table.innerHTML="";

  const head=document.createElement("tr");
  ["Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨","Ø§Ù„ÙˆØµÙ","Ø§Ù„ØªØ§Ø±ÙŠØ®","Ø§Ù„Ø­Ø§Ù„Ø©","Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª"].forEach(t=>{
    const th=document.createElement("th");
    th.textContent=t;
    head.appendChild(th);
  });
  table.appendChild(head);

  rows.forEach(r=>{
    const tr=document.createElement("tr");

    const order=r["Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨"];
    const desc=r["ÙˆØµÙ Ø§Ù„Ø·Ù„Ø¨"];
    const dt=normalizeDateTime(r[state.dateCol]);
    const phone=r[state.mobileCol];

    tr.innerHTML=`
      <td>${order} <button class="copy-btn" data-text="${order}">ğŸ“‹</button></td>
      <td>${desc} <button class="copy-btn" data-text="${desc}">ğŸ“‹</button></td>
      <td>${dt}</td>
      <td class="status-cell">${r["Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨"]||""}</td>
      <td>
        <button class="btn-view" onclick="openViewModal('${phone}')">Ø¹Ø±Ø¶</button>
        <button class="btn-wa" onclick="sendWA('${phone}','${order}','${desc}')">ÙˆØ§ØªØ³Ø§Ø¨</button>
        <button class="btn-done" onclick="markDone(this,'${order}','${normalizeDate(r[state.dateCol])}')">ØªÙ…</button>
      </td>
    `;

    if (doneStore.includes(String(order))) {
        tr.classList.add("done-row");
        r["Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨"]="ØªÙ… Ø¥Ù†Ø¬Ø§Ø²Ù‡";
    }

    table.appendChild(tr);
  });

  toggleModal("viewModal",true);
}

// Ø²Ø± ØªÙ… â€” Ø­ÙØ¸ Ø¯Ø§Ø¦Ù…
function markDone(btn,order,dateStr){
  const tr=btn.closest("tr");
  tr.classList.add("done-row");
  tr.querySelector(".status-cell").textContent="ØªÙ… Ø¥Ù†Ø¬Ø§Ø²Ù‡";

  // ØªØ®Ø²ÙŠÙ† Ø¯Ø§Ø¦Ù…
  if(!doneStore.includes(order)){
    doneStore.push(order);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(doneStore));
  }

  const row=state.rows.find(r =>
    normalizeDate(r[state.dateCol])===dateStr &&
    (r["Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨"]||"").toString()===order
  );
  if(row) row["Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨"]="ØªÙ… Ø¥Ù†Ø¬Ø§Ø²Ù‡";

  renderCalendar();
}

// ØªÙ… Ù„Ù„Ø¬Ù…ÙŠØ¹
function markAllDuplicatesDone(){
  const list = state.rows.filter(r => String(r[state.mobileCol]) === String(currentMobile));

  list.forEach(r=>{
    r["Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨"]="ØªÙ… Ø¥Ù†Ø¬Ø§Ø²Ù‡";
    const id = String(r["Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨"]);
    if(!doneStore.includes(id)){
        doneStore.push(id);
    }
  });

  localStorage.setItem(STORAGE_KEY, JSON.stringify(doneStore));

  renderMainTable(state.rows);
  renderCalendar();
  toggleModal("viewModal",false);
}

// Ø²Ø± Ø§Ù„Ù†Ø³Ø® â€” ÙŠØ¹Ù…Ù„ 100% Ù„Ù„Ø¬ÙˆØ§Ù„
document.addEventListener("click", async e=>{
  const btn = e.target.closest(".copy-btn");
  if(!btn) return;

  const text = btn.dataset.text || "";

  if(navigator.clipboard && window.isSecureContext){
      navigator.clipboard.writeText(text).catch(()=>{
          fallbackCopy(text);
      });
  } else {
      fallbackCopy(text);
  }
});

// fallback Ù„Ù„Ù†Ø³Ø®
function fallbackCopy(text){
  const area=document.createElement("textarea");
  area.value=text;
  area.style.position="fixed";
  area.style.opacity=0;
  document.body.appendChild(area);
  area.focus();
  area.select();
  document.execCommand("copy");
  area.remove();
}

// ÙˆØ§ØªØ³Ø§Ø¨
function sendWA(phone,order,desc){
  let p=String(phone).replace(/\D/g,"");

  if(p.startsWith("0")) p="966"+p.slice(1);
  else if(!p.startsWith("966")) p="966"+p;

  const msg=`Ø·Ù„Ø¨ ${order}: ${desc}`;
  window.open(`https://wa.me/${p}?text=${encodeURIComponent(msg)}`,"_blank");
}

// Ø£Ø¯ÙˆØ§Øª
function toggleModal(id,show){ $(id).style.display=show?"flex":"none"; }
function pad(n){ return String(n).padStart(2,"0"); }

/* =========================================
   âœ… ØªØ¹Ø¯ÙŠÙ„ Ù…Ù‡Ù…: ÙÙƒ ØªØ§Ø±ÙŠØ® Excel/Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨ØµÙŠØºØ© MM/DD/YY + AM/PM
   ÙŠØ¯Ø¹Ù…:
   2/5/26 8:50:38 PM
   02/05/2026 08:50:38 AM
   ========================================= */
function parseDateTimeSafe(raw){
  if(raw===null || raw===undefined || raw==="") return null;

  // Ù„Ùˆ Excel Ø±Ù‚Ù… (Serial)
  if(typeof raw==="number"){
    // Excel epoch: 1899-12-30
    const ms = Math.round((raw - 25569) * 86400 * 1000);
    const d = new Date(ms);
    return isNaN(d) ? null : d;
  }

  const t = String(raw).trim();

  // ØµÙŠØºØ©: M/D/YY HH:MM:SS AM/PM
  const m = t.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?\s*(AM|PM)?)?/i);
  if(m){
    let MM = parseInt(m[1],10);
    let DD = parseInt(m[2],10);
    let YY = m[3];
    YY = (YY.length===2) ? ("20"+YY) : YY;
    let hh = m[4] ? parseInt(m[4],10) : 0;
    let mi = m[5] ? parseInt(m[5],10) : 0;
    let ss = m[6] ? parseInt(m[6],10) : 0;
    const ap = (m[7]||"").toUpperCase();

    if(ap==="PM" && hh<12) hh+=12;
    if(ap==="AM" && hh===12) hh=0;

    const d = new Date(parseInt(YY,10), MM-1, DD, hh, mi, ss);
    return isNaN(d) ? null : d;
  }

  // fallback
  const d2 = new Date(t);
  return isNaN(d2) ? null : d2;
}

// âœ… normalizeDate ÙŠØ³ØªØ®Ø¯Ù… parseDateTimeSafe Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„ÙŠÙˆÙ…
function normalizeDate(raw){
  const dt = parseDateTimeSafe(raw);
  return (!dt) ? "" : `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())}`;
}

// âœ… normalizeDateTime ÙŠØ³ØªØ®Ø¯Ù… parseDateTimeSafe Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„ÙˆÙ‚Øª
function normalizeDateTime(raw){
  const dt = parseDateTimeSafe(raw);
  if(!dt) return "";
  return `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())} `
        +`${pad(dt.getHours())}:${pad(dt.getMinutes())}:${pad(dt.getSeconds())}`;
}

</script>
</body>
</html>
