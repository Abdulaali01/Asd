<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ðŸ“‹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª â€” Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© v21</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{font-family:Tahoma,Arial,sans-serif;background:#fafafa;margin:0;padding:18px}
h2{margin:0 0 12px}
.toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
button{padding:6px 10px;border:none;border-radius:8px;cursor:pointer}
.btn{background:#eee}
.btn-view{background:#0b74da;color:#fff}
.btn-wa{background:#25D366;color:#fff}
.btn-done{background:#f44336;color:#fff}
.copy-btn{background:#555;color:#fff;border-radius:4px;padding:2px 6px;font-size:11px}
table{width:100%;min-width:900px;border-collapse:collapse;background:#fff}
th,td{border:1px solid #ddd;padding:6px;text-align:center}
th{background:#f0f0f0}
tr.done-row{background:#ffdddd}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);justify-content:center;align-items:center;z-index:9999;padding:14px}
.modal-content{background:#fff;border-radius:10px;padding:14px;max-height:95vh;overflow:auto;width:95vw;max-width:1100px}
.calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:2px}
.calendar div{border:1px solid #ccc;border-radius:4px;padding:4px;min-height:85px}
.blink{animation:blinkAnim 1s infinite}
@keyframes blinkAnim{50%{opacity:.3}}
</style>
</head>

<body>

<h2>ðŸ“‹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h2>

<div class="toolbar">
<input type="file" id="file" accept=".xlsx,.xls">
<button class="btn" id="btnCalendar">ðŸ“… Ø§Ù„ÙƒÙ„ÙŠÙ†Ø¯Ø± Ø§Ù„Ø´Ù‡Ø±ÙŠ</button>
</div>

<table id="tbl"></table>

<div id="calendarModal" class="modal">
<div class="modal-content">
<input type="month" id="monthPicker">
<div id="calendarGrid" class="calendar"></div>
</div>
</div>

<script>

const STORAGE_KEY = location.hostname + "_doneOrders";
let doneStore = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");

const state={rows:[],dateCol:"ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡",mobileCol:"Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…Ø³ØªÙÙŠØ¯"};
const $=id=>document.getElementById(id);
let currentMobile=null;

const TARGET_STATUSES=[
"Ù…Ø¹Ù„Ù‚ - Ù‚Ø±Ø§Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©",
"Ù…Ø¹Ù„Ù‚ - Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ø´Ø±Ù"
];

file.addEventListener("change",async e=>{
const buf=await e.target.files[0].arrayBuffer();
const wb=XLSX.read(buf,{type:"array"});
const ws=wb.Sheets[wb.SheetNames[0]];

state.rows=XLSX.utils.sheet_to_json(ws,{defval:""}).map(r=>{
let p=String(r[state.mobileCol]||"").replace(/\D/g,"");
if(p.startsWith("0"))p="966"+p.slice(1);
if(!p.startsWith("966"))p="966"+p;
r[state.mobileCol]=p;
if(doneStore.includes(String(r["Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨"]))) r["Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨"]="ØªÙ… Ø¥Ù†Ø¬Ø§Ø²Ù‡";
return r;
});
});

btnCalendar.onclick=()=>{
calendarModal.style.display="flex";
monthPicker.value=new Date().toISOString().slice(0,7);
renderCalendar();
};

monthPicker.onchange=renderCalendar;

function renderCalendar(){
calendarGrid.innerHTML="";
const [y,m]=monthPicker.value.split("-");
const first=new Date(y,m-1,1);
const last=new Date(y,m,0);

for(let i=0;i<first.getDay();i++)calendarGrid.appendChild(document.createElement("div"));

for(let d=1;d<=last.getDate();d++){
const cell=document.createElement("div");
const ds=`${y}-${pad(m)}-${pad(d)}`;
const rows=state.rows.filter(r=>norm(r[state.dateCol])===ds);
const pending=rows.filter(r=>TARGET_STATUSES.includes(r["Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨"]||""));

if(rows.length&&!pending.length)cell.style.background="#c8e6c9";
else if(pending.length)cell.style.background="#ffe0b2";

cell.innerHTML=d+"<br>Ù…Ø¹Ù„Ù‚:"+pending.length;
calendarGrid.appendChild(cell);
}
}

function markDone(id){
if(!doneStore.includes(id)){
doneStore.push(id);
localStorage.setItem(STORAGE_KEY,JSON.stringify(doneStore));
}
renderCalendar();
}

function pad(n){return String(n).padStart(2,"0")}
function norm(d){const x=new Date(d);return `${x.getFullYear()}-${pad(x.getMonth()+1)}-${pad(x.getDate())}`}

</script>

</body>
</html>
